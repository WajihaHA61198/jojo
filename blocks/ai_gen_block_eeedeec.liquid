{% doc %}
  @prompt
    generate a recently viewed products section and place them in grid
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-recently-viewed-{{ ai_gen_id }} {
    padding: {{ block.settings.section_padding_top }}px 0 {{ block.settings.section_padding_bottom }}px;
  }

  .ai-recently-viewed-container-{{ ai_gen_id }} {
    max-width: {{ settings.page_width }}px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .ai-recently-viewed-header-{{ ai_gen_id }} {
    text-align: {{ block.settings.heading_alignment }};
    margin-bottom: {{ block.settings.heading_margin_bottom }}px;
  }

  .ai-recently-viewed-title-{{ ai_gen_id }} {
    font-size: {{ block.settings.heading_size }}px;
    margin: 0;
    color: rgb(var(--color-foreground));
    font-family: var(--font-heading-family);
  }

  .ai-recently-viewed-grid-{{ ai_gen_id }} {
    display: grid;
    grid-template-columns: repeat({{ block.settings.columns_desktop }}, 1fr);
    gap: {{ settings.spacing_grid_horizontal }}px {{ settings.spacing_grid_vertical }}px;
    margin-top: 20px;
  }

  .ai-recently-viewed-product-{{ ai_gen_id }} {
    position: relative;
    text-align: {{ settings.card_text_alignment }};
    border-radius: {{ settings.card_corner_radius }}px;
    {% if settings.card_style == 'card' %}
      background-color: rgb(var(--color-background));
      border: {{ settings.card_border_thickness }}px solid rgba(var(--color-foreground), {{ settings.card_border_opacity | divided_by: 100.0 }});
      box-shadow: {{ settings.card_shadow_horizontal_offset }}px {{ settings.card_shadow_vertical_offset }}px {{ settings.card_shadow_blur }}px rgba(var(--color-shadow), {{ settings.card_shadow_opacity | divided_by: 100.0 }});
      padding: 20px;
    {% endif %}
    transition: transform 0.3s ease;
  }

  .ai-recently-viewed-product-{{ ai_gen_id }}:hover {
    {% if settings.animations_hover_elements == 'vertical-lift' %}
      transform: translateY(-5px);
    {% elsif settings.animations_hover_elements == '3d-lift' %}
      transform: translateY(-5px) scale(1.02);
    {% endif %}
  }

  .ai-recently-viewed-image-wrapper-{{ ai_gen_id }} {
    position: relative;
    margin-bottom: 15px;
    border-radius: {{ settings.media_radius }}px;
    overflow: hidden;
    border: {{ settings.media_border_thickness }}px solid rgba(var(--color-foreground), {{ settings.media_border_opacity | divided_by: 100.0 }});
    box-shadow: {{ settings.media_shadow_horizontal_offset }}px {{ settings.media_shadow_vertical_offset }}px {{ settings.media_shadow_blur }}px rgba(var(--color-shadow), {{ settings.media_shadow_opacity | divided_by: 100.0 }});
  }

  .ai-recently-viewed-image-{{ ai_gen_id }} {
    width: 100%;
    height: auto;
    aspect-ratio: {{ block.settings.image_ratio }};
    object-fit: cover;
    display: block;
  }

  .ai-recently-viewed-product-info-{{ ai_gen_id }} {
    padding: {{ settings.card_image_padding }}px;
  }

  .ai-recently-viewed-product-title-{{ ai_gen_id }} {
    font-size: 16px;
    font-weight: 500;
    margin: 0 0 8px;
    color: rgb(var(--color-foreground));
    text-decoration: none;
    display: block;
  }

  .ai-recently-viewed-product-title-{{ ai_gen_id }}:hover {
    color: rgb(var(--color-foreground));
    opacity: 0.8;
  }

  .ai-recently-viewed-product-vendor-{{ ai_gen_id }} {
    font-size: 14px;
    color: rgba(var(--color-foreground), 0.7);
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .ai-recently-viewed-product-price-{{ ai_gen_id }} {
    font-size: 16px;
    font-weight: 600;
    color: rgb(var(--color-foreground));
    margin-bottom: 15px;
  }

  .ai-recently-viewed-product-price-{{ ai_gen_id }} .price--on-sale {
    color: rgb(var(--color-sale-text));
  }

  .ai-recently-viewed-product-price-{{ ai_gen_id }} .price--compare {
    text-decoration: line-through;
    opacity: 0.7;
    margin-left: 8px;
  }

  .ai-recently-viewed-button-{{ ai_gen_id }} {
    background-color: rgb(var(--color-button));
    color: rgb(var(--color-button-text));
    border: {{ settings.buttons_border_thickness }}px solid rgba(var(--color-button), {{ settings.buttons_border_opacity | divided_by: 100.0 }});
    border-radius: {{ settings.buttons_radius }}px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: {{ settings.buttons_shadow_horizontal_offset }}px {{ settings.buttons_shadow_vertical_offset }}px {{ settings.buttons_shadow_blur }}px rgba(var(--color-shadow), {{ settings.buttons_shadow_opacity | divided_by: 100.0 }});
  }

  .ai-recently-viewed-button-{{ ai_gen_id }}:hover {
    background-color: rgba(var(--color-button), 0.8);
    color: rgb(var(--color-button-text));
  }

  .ai-recently-viewed-empty-{{ ai_gen_id }} {
    text-align: center;
    padding: 60px 20px;
    color: rgba(var(--color-foreground), 0.7);
  }

  .ai-recently-viewed-empty-icon-{{ ai_gen_id }} {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    opacity: 0.3;
  }

  .ai-recently-viewed-empty-title-{{ ai_gen_id }} {
    font-size: 24px;
    margin: 0 0 10px;
    color: rgb(var(--color-foreground));
  }

  .ai-recently-viewed-empty-text-{{ ai_gen_id }} {
    font-size: 16px;
    margin: 0;
  }

  @media screen and (max-width: 990px) {
    .ai-recently-viewed-grid-{{ ai_gen_id }} {
      grid-template-columns: repeat({{ block.settings.columns_tablet }}, 1fr);
    }
  }

  @media screen and (max-width: 749px) {
    .ai-recently-viewed-grid-{{ ai_gen_id }} {
      grid-template-columns: repeat({{ block.settings.columns_mobile }}, 1fr);
    }

    .ai-recently-viewed-container-{{ ai_gen_id }} {
      padding: 0 15px;
    }

    .ai-recently-viewed-title-{{ ai_gen_id }} {
      font-size: {{ block.settings.heading_size | times: 0.8 }}px;
    }
  }
{% endstyle %}

<recently-viewed-products-{{ ai_gen_id }}
  class="ai-recently-viewed-{{ ai_gen_id }} color-{{ block.settings.color_scheme }}"
  data-max-products="{{ block.settings.max_products }}"
  {{ block.shopify_attributes }}
>
  <div class="ai-recently-viewed-container-{{ ai_gen_id }}">
    {% if block.settings.heading != blank %}
      <div class="ai-recently-viewed-header-{{ ai_gen_id }}">
        <h2 class="ai-recently-viewed-title-{{ ai_gen_id }}">{{ block.settings.heading }}</h2>
      </div>
    {% endif %}

    <div class="ai-recently-viewed-products-{{ ai_gen_id }}">
      <div class="ai-recently-viewed-empty-{{ ai_gen_id }}" style="display: none;">
        <div class="ai-recently-viewed-empty-icon-{{ ai_gen_id }}">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
        </div>
        <h3 class="ai-recently-viewed-empty-title-{{ ai_gen_id }}">{{ block.settings.empty_title }}</h3>
        <p class="ai-recently-viewed-empty-text-{{ ai_gen_id }}">{{ block.settings.empty_text }}</p>
      </div>

      <div class="ai-recently-viewed-grid-{{ ai_gen_id }}" style="display: none;"></div>
    </div>
  </div>
</recently-viewed-products-{{ ai_gen_id }}>

<script>
  (function() {
    class RecentlyViewedProducts{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.maxProducts = parseInt(this.dataset.maxProducts) || 8;
        this.storageKey = 'recently_viewed_products';
        this.currentProductId = window.location.pathname.includes('/products/') ? 
          this.extractProductIdFromUrl() : null;
      }

      connectedCallback() {
        this.loadRecentlyViewedProducts();
        this.trackCurrentProduct();
      }

      extractProductIdFromUrl() {
        const pathParts = window.location.pathname.split('/');
        const productIndex = pathParts.indexOf('products');
        if (productIndex !== -1 && pathParts[productIndex + 1]) {
          return pathParts[productIndex + 1];
        }
        return null;
      }

      trackCurrentProduct() {
        if (!this.currentProductId) return;

        const productData = this.extractProductDataFromPage();
        if (productData) {
          this.addToRecentlyViewed(productData);
        }
      }

      extractProductDataFromPage() {
        const productJson = document.querySelector('[data-product-json]');
        if (productJson) {
          try {
            return JSON.parse(productJson.textContent);
          } catch (e) {
            console.warn('Could not parse product JSON');
          }
        }

        const titleElement = document.querySelector('.product__title, h1');
        const priceElement = document.querySelector('.price, .product__price');
        const imageElement = document.querySelector('.product__media img, .product-single__photo img');

        if (titleElement) {
          return {
            id: this.currentProductId,
            title: titleElement.textContent.trim(),
            handle: this.currentProductId,
            price: priceElement ? priceElement.textContent.trim() : '',
            featured_image: imageElement ? imageElement.src : '',
            url: window.location.pathname,
            vendor: document.querySelector('.product__vendor, .product-single__vendor')?.textContent?.trim() || ''
          };
        }

        return null;
      }

      addToRecentlyViewed(product) {
        let recentlyViewed = this.getRecentlyViewed();
        
        recentlyViewed = recentlyViewed.filter(item => item.id !== product.id);
        recentlyViewed.unshift(product);
        recentlyViewed = recentlyViewed.slice(0, this.maxProducts);

        localStorage.setItem(this.storageKey, JSON.stringify(recentlyViewed));
      }

      getRecentlyViewed() {
        try {
          return JSON.parse(localStorage.getItem(this.storageKey)) || [];
        } catch (e) {
          return [];
        }
      }

      async loadRecentlyViewedProducts() {
        const recentlyViewed = this.getRecentlyViewed();
        const filteredProducts = recentlyViewed.filter(product => 
          product.id !== this.currentProductId
        );

        if (filteredProducts.length === 0) {
          this.showEmptyState();
          return;
        }

        try {
          const productHandles = filteredProducts.map(p => p.handle || p.id).slice(0, this.maxProducts);
          const products = await this.fetchProductDetails(productHandles);
          this.renderProducts(products);
        } catch (error) {
          console.warn('Could not load recently viewed products:', error);
          this.showEmptyState();
        }
      }

      async fetchProductDetails(handles) {
        const promises = handles.map(handle => 
          fetch(`/products/${handle}.js`)
            .then(response => response.ok ? response.json() : null)
            .catch(() => null)
        );

        const results = await Promise.all(promises);
        return results.filter(product => product !== null);
      }

      renderProducts(products) {
        if (products.length === 0) {
          this.showEmptyState();
          return;
        }

        const grid = this.querySelector('.ai-recently-viewed-grid-{{ ai_gen_id }}');
        const emptyState = this.querySelector('.ai-recently-viewed-empty-{{ ai_gen_id }}');

        grid.innerHTML = products.map(product => this.createProductHTML(product)).join('');
        grid.style.display = 'grid';
        emptyState.style.display = 'none';
      }

      createProductHTML(product) {
        const showVendor = {{ block.settings.show_vendor | json }};
        const showPrice = {{ block.settings.show_price | json }};
        const showButton = {{ block.settings.show_add_to_cart | json }};
        
        const imageUrl = product.featured_image ? 
          product.featured_image.replace(/\.(jpg|jpeg|png|gif|webp)/, '_300x300.$1') : 
          '';

        const price = product.price ? (product.price / 100).toFixed(2) : '';
        const comparePrice = product.compare_at_price && product.compare_at_price > product.price ? 
          (product.compare_at_price / 100).toFixed(2) : '';

        return `
          <div class="ai-recently-viewed-product-{{ ai_gen_id }}">
            <div class="ai-recently-viewed-image-wrapper-{{ ai_gen_id }}">
              ${imageUrl ? 
                `<img src="${imageUrl}" alt="${product.title}" class="ai-recently-viewed-image-{{ ai_gen_id }}" loading="lazy">` :
                `<div class="ai-recently-viewed-image-{{ ai_gen_id }}" style="background-color: #f4f4f4; display: flex; align-items: center; justify-content: center;">
                  <svg width="60" height="60" fill="currentColor" opacity="0.3">
                    <rect width="60" height="60" fill="#ddd"/>
                    <text x="30" y="35" text-anchor="middle" font-size="10" fill="#999">No Image</text>
                  </svg>
                </div>`
              }
            </div>
            <div class="ai-recently-viewed-product-info-{{ ai_gen_id }}">
              ${showVendor && product.vendor ? `<div class="ai-recently-viewed-product-vendor-{{ ai_gen_id }}">${product.vendor}</div>` : ''}
              <a href="/products/${product.handle}" class="ai-recently-viewed-product-title-{{ ai_gen_id }}">
                ${product.title}
              </a>
              ${showPrice && price ? `
                <div class="ai-recently-viewed-product-price-{{ ai_gen_id }}">
                  <span class="${comparePrice ? 'price--on-sale' : ''}">${Shopify.formatMoney(product.price, window.theme?.moneyFormat || '{{amount}}')}</span>
                  ${comparePrice ? `<span class="price--compare">${Shopify.formatMoney(product.compare_at_price, window.theme?.moneyFormat || '{{amount}}')}</span>` : ''}
                </div>
              ` : ''}
              ${showButton ? `
                <a href="/products/${product.handle}" class="ai-recently-viewed-button-{{ ai_gen_id }}">
                  {{ block.settings.button_text }}
                </a>
              ` : ''}
            </div>
          </div>
        `;
      }

      showEmptyState() {
        const grid = this.querySelector('.ai-recently-viewed-grid-{{ ai_gen_id }}');
        const emptyState = this.querySelector('.ai-recently-viewed-empty-{{ ai_gen_id }}');
        
        grid.style.display = 'none';
        emptyState.style.display = 'block';
      }
    }

    customElements.define('recently-viewed-products-{{ ai_gen_id }}', RecentlyViewedProducts{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Recently viewed products",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Recently viewed"
    },
    {
      "type": "range",
      "id": "max_products",
      "min": 4,
      "max": 12,
      "step": 1,
      "label": "Maximum products to show",
      "default": 8
    },
    {
      "type": "text",
      "id": "empty_title",
      "label": "Empty state title",
      "default": "No recently viewed products"
    },
    {
      "type": "text",
      "id": "empty_text",
      "label": "Empty state text",
      "default": "Start browsing products to see them here"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "columns_desktop",
      "label": "Columns on desktop",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" },
        { "value": "5", "label": "5" }
      ],
      "default": "4"
    },
    {
      "type": "select",
      "id": "columns_tablet",
      "label": "Columns on tablet",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ],
      "default": "3"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Columns on mobile",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ],
      "default": "2"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Image aspect ratio",
      "options": [
        { "value": "1/1", "label": "Square (1:1)" },
        { "value": "4/3", "label": "Landscape (4:3)" },
        { "value": "3/4", "label": "Portrait (3:4)" },
        { "value": "16/9", "label": "Widescreen (16:9)" }
      ],
      "default": "1/1"
    },
    {
      "type": "header",
      "content": "Product information"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_price",
      "label": "Show price",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "label": "Show view product button",
      "default": true
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "View product"
    },
    {
      "type": "header",
      "content": "Heading style"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 16,
      "max": 48,
      "step": 2,
      "unit": "px",
      "label": "Heading size",
      "default": 32
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "range",
      "id": "heading_margin_bottom",
      "min": 0,
      "max": 60,
      "step": 4,
      "unit": "px",
      "label": "Heading bottom margin",
      "default": 32
    },
    {
      "type": "header",
      "content": "Section spacing"
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 60
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 60
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1"
    }
  ],
  "presets": [
    {
      "name": "Recently viewed products"
    }
  ]
}
{% endschema %}
